# Canvas 日历引擎开发计划

## 目标
- 用 Canvas 实现一个完全可控的日历引擎
- 页面中只有一个 `<canvas>`，所有 UI 元素都在 Canvas 内绘制
- 支持多视图（个人/组，日/周/月/年）
- 横纵轴可配置，事件块自动布局
- 支持基础交互（点击、拖拽、滚动）
- UI 具有圆角、阴影、标签等效果
- 提供动画效果增强体验

---

## 一、视图体系

1. **个人日视图**：纵轴 = 小时，横轴 = 空  
2. **个人周视图**：纵轴 = 小时，横轴 = 天  
3. **个人月视图**：纵轴 = 拼接天，横轴 = 星期  
4. **个人年视图**：上半部分 1-6 月，下半部分 7-12 月  
5. **组日视图**：纵轴 = 用户，横轴 = 小时  
6. **组周视图**：纵轴 = 用户，横轴 = 天  

> 用户可自定义视图，视图对象包含横纵坐标轴映射、布局规则、标签渲染规则。

---

## 二、核心数据结构

### Event
- `id`  
- `startTime`, `endTime` (timestamp)  
- `userId` (可选)  
- `layer` (渲染层)  
- `crossDay` (boolean)  
- `metadata` (颜色、标签等)

### ViewConfig
- `name`  
- `xAxis`, `yAxis`（坐标映射函数/scale）  
- `layoutRules`（重叠处理、跨日处理、最小层数）  
- `labelRules`（横纵轴标签显示方式）

### Rect（layout 输出）
- `x, y, w, h`  
- `layer`  
- `eventId`  
- 可选 UI 样式（color, radius, shadow）

---

## 三、技术栈与库

- **必选**：
  - Canvas 2D API
  - d3-scale（时间/用户坐标映射）
  - lodash / tiny-helpers（数组操作）
  - TypeScript（类型安全管理复杂布局数据，强烈推荐）

- **可选**：
  - GSAP / framer-motion（动画加速）
  - dat.gui / lil-gui（原型调试）
  - RBush（空间索引，优化大量事件的碰撞检测）

---

## 四、渲染 & UI

- **事件块**：`ctx.fillRect` 或自定义 `roundRect`  
- **圆角**：自定义函数或 `ctx.roundRect`  
- **阴影**：
  ```js
  ctx.shadowColor = 'rgba(0,0,0,0.2)';
  ctx.shadowBlur = 6;
  ctx.shadowOffsetX = 0;
  ctx.shadowOffsetY = 2;
  ```

- **网格与标签**：`ctx.moveTo` / `lineTo`, `ctx.fillText`

- **按钮 / 视图切换**：Canvas 内绘制矩形 + 文字，点击事件计算坐标命中

- **所有 UI 元素、交互都在 Canvas 内完成**，DOM 仅用于承载 `<canvas>`。

---

## 五、开发顺序（最小可用原型优先）

### 第一阶段：核心渲染
1. **Canvas 初始化**
   - 创建 canvas，响应式尺寸（监听 window.resize）
   - 设置 DPR（devicePixelRatio）处理高清屏
   - 主循环 requestAnimationFrame

2. **坐标轴映射**
   - 实现 xAxis / yAxis scale（d3-scale）
   - 测试横纵轴映射正确性
   - 实现世界坐标 ↔ 屏幕坐标转换

3. **layout 引擎**
   - 输入事件数组 + viewConfig
   - 输出 rects[]
   - 支持跨日事件、重叠事件最小层数
   - 边界情况：极短事件（<15分钟）最小高度

4. **基础渲染**
   - 网格、标签
   - 事件块（圆角 + 阴影）
   - 文本截断与省略号
   - 视图切换按钮

### 第二阶段：交互与状态
5. **基础交互**
   - 点击事件块（命中测试）
   - 滚动视图（鼠标滚轮 + 拖拽）
   - hover 效果（鼠标悬停高亮）

6. **事件 CRUD**
   - 双击空白区域创建事件
   - 点击事件显示详情（弹窗或侧边栏）
   - 拖拽调整时间/时长
   - 删除事件（键盘 Delete 或右键菜单）

7. **状态管理**
   - 撤销/重做栈
   - 冲突检测与提示
   - 数据持久化（localStorage / API）

### 第三阶段：优化与增强
8. **性能优化**
   - 脏矩形局部重绘
   - 离屏 canvas 缓存静态内容
   - 视口裁剪（只渲染可见事件）
   - 防抖/节流（resize、scroll）

9. **动画效果**
   - 事件块移动过渡
   - 缓动 / 惯性滚动
   - 视图切换平滑过渡
   - 加载骨架屏动画

10. **可访问性与多端适配**
    - 键盘快捷键（方向键导航、快捷创建）
    - 触摸事件支持（移动端）
    - ARIA 标签（隐藏 DOM 提供语义）
    - 暗黑模式支持

---

## 六、动画效果思路

- **基础原则**：
  - 所有动画由世界坐标计算
  - Canvas 只绘制当前帧，不依赖 DOM 动画
  - 动画数据与渲染数据分离（动画控制 target，渲染读取 current）

- **常用方式**：
  - **位置插值（lerp）**：
    ```js
    rect.x = rect.x + (targetX - rect.x) * 0.2
    ```
  - **透明度渐变**：
    ```js
    ctx.globalAlpha = alpha
    ```
  - **惯性滑动**：
    ```js
    // 鼠标拖动记录速度
    offset += velocity
    velocity *= friction
    ```
  - **缓动函数**（easeInOutCubic）：
    ```js
    const easeInOutCubic = (t) => 
      t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2
    ```

- **动画库可选**：
  - GSAP / framer-motion：控制 canvas 属性或封装对象动画
  - 自定义 requestAnimationFrame 循环：完全控制，无外部依赖

- **性能建议**：
  - 动画进行时只重绘变化区域（脏矩形）
  - 避免在动画中频繁创建对象（对象池复用）
  - 使用 `will-change` CSS 属性（如需 DOM 叠加层）

---

## 七、性能优化策略

### 渲染优化
1. **脏矩形重绘**：
   - 记录变化区域，只清除和重绘该区域
   - 适用场景：局部交互（hover、拖拽单个事件）

2. **离屏 canvas 缓存**：
   - 缓存静态内容（网格、标签）到离屏 canvas
   - 每帧直接 `drawImage` 拷贝，避免重复绘制
   ```js
   // 初始化时
   const bgCanvas = document.createElement('canvas')
   drawGrid(bgCanvas.getContext('2d'))
   
   // 每帧
   ctx.drawImage(bgCanvas, 0, 0)
   ```

3. **视口裁剪**：
   - 计算当前视口范围
   - 只渲染可见事件（时间范围过滤）
   - 大数据场景下性能提升显著

4. **防抖与节流**：
   - resize 事件防抖（300ms）
   - scroll 事件节流（16ms，~60fps）

### 布局优化
1. **空间索引**（RBush）：
   - 大量事件时加速碰撞检测
   - 快速查询某区域内的事件

2. **增量布局**：
   - 只重新计算变化的事件布局
   - 缓存稳定事件的 rect

### 数据优化
1. **虚拟滚动**（时间维度）：
   - 月视图/年视图只加载可见月份数据
   - 滚动时按需加载前后数据

2. **Web Worker**：
   - 复杂布局计算放入 Worker
   - 主线程只负责渲染，避免阻塞

---

## 八、交互完整性

### 事件操作流程
1. **创建事件**：
   - 双击空白区域 → 创建临时事件块
   - 拖拽调整时长 → 松开保存
   - 备选：点击空白 → 弹出时间选择器

2. **编辑事件**：
   - 点击事件块 → 显示详情面板
   - 拖拽事件块 → 改变开始时间
   - 拖拽事件块边缘 → 改变时长
   - 双击事件块 → 进入编辑模式

3. **删除事件**：
   - 选中事件 + 键盘 Delete/Backspace
   - 右键菜单 → 删除选项
   - 拖拽到"删除区域"

### 交互状态机
```
Idle
  ├─ hover → Hover（高亮事件）
  ├─ click → Selected（显示详情）
  ├─ doubleClick (空白) → Creating（创建事件）
  └─ mouseDown (事件) → DragStart
       └─ mouseMove → Dragging（移动/调整时长）
            └─ mouseUp → DragEnd（保存变更）
```

### 冲突检测
- 同一用户时间重叠 → 警告提示
- 可配置策略：禁止创建 / 允许创建但高亮冲突

### 键盘快捷键
- `↑/↓/←/→`：导航选择事件
- `Enter`：编辑选中事件
- `Delete/Backspace`：删除事件
- `Cmd/Ctrl + Z`：撤销
- `Cmd/Ctrl + Shift + Z`：重做
- `Cmd/Ctrl + C/V`：复制/粘贴事件
- `Esc`：取消当前操作

---

## 九、边界情况处理

1. **极短事件（<15分钟）**：
   - 设置最小渲染高度（如 20px）
   - 缩小字号或只显示图标
   - hover 显示完整信息

2. **跨日/跨周/跨月事件**：
   - 视觉上拆分为多段
   - 每段标记"续上"或"续下"
   - 点击任意段跳转到完整视图

3. **全天事件**：
   - 单独区域渲染（顶部横条）
   - 不占用时间轴空间

4. **时区处理**：
   - 所有时间戳统一存储为 UTC
   - 渲染时根据用户时区转换
   - 跨时区协作时显示原始时区标记

5. **数据为空**：
   - 显示空状态插画 + 引导文案
   - "点击创建第一个事件"

6. **超大数据量**（>1000 事件）：
   - 启用虚拟滚动
   - 视口外事件简化渲染（只画占位符）
   - 提供"按项目/标签筛选"功能

7. **文本溢出**：
   - 测量文本宽度（`ctx.measureText`）
   - 超出宽度截断 + 省略号
   - hover 显示完整标题（tooltip）

8. **重叠事件过多**：
   - 超过 N 层（如 5 层）收起显示
   - 点击展开完整视图
   - 或切换到列表视图

---

## 十、可访问性与响应式

### 可访问性
1. **屏幕阅读器支持**：
   - 维护隐藏的 DOM 结构（`aria-hidden="false"`）
   - 同步 canvas 渲染状态到 DOM
   - 事件块映射为 `<button>` 或 `<div role="button">`

2. **键盘导航**：见第八章快捷键部分

3. **高对比度模式**：
   - 检测系统设置（`prefers-contrast: high`）
   - 调整颜色方案（更强对比度）

### 响应式设计
1. **窗口 resize**：
   - 监听 `window.resize`
   - 重新计算 canvas 尺寸和 DPR
   - 触发完整重绘

2. **移动端适配**：
   - 触摸事件（`touchstart/move/end`）替代鼠标事件
   - 双指缩放调整视图范围
   - 简化 UI（减少标签密度）

3. **断点设计**：
   - 小屏（<768px）：隐藏部分标签、增大点击区域
   - 中屏（768-1024px）：标准视图
   - 大屏（>1024px）：显示更多信息、侧边栏

---

## 十一、核心思想总结

- **一切皆数据驱动**：视图配置、布局规则、动画状态都是纯数据
- **分层架构**：数据层（Event）→ 布局层（Rect）→ 渲染层（Canvas）→ 交互层
- **性能优先**：大数据场景下必须优化，小数据场景保持简洁
- **渐进增强**：从 MVP 开始，逐步添加动画、优化、高级交互